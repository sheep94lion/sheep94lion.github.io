<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv = "Content-Type" content = "text/html; charset=UTF-8">
		<link rel = "stylesheet" type = "text/css" href = "style.css" />
		<script src = "jquery-1.11.3.min.js"></script>
		<script>
			var xmlhttp;
			var xmlhttp_comment;
			var flag = 1;
			var page = 1;
			var index = 1;
			var picid;
			function clickpic(){
				$('.shelter').css('visibility', 'visible');
				$('#bigpic').attr('src', this.src);
				$('#bigpic').css('visibility', 'visible')
				$('#bigpic_pic_img').attr('src', this.src)
				$('#bigpic').css('left', (($(window).width()- $('#bigpic').width()) / 2).toString() + 'px');
				$('#bigpic').css('top', (($(window).height() - $('#bigpic').height()) / 2).toString() + 'px');
				$('#bigpic').css('height', $('#bigpic_pic_img').css('height'));
				$('#bigpic_pic_div').css('height', $('#bigpic_pic_img').css('height'));
				//下面获取评论 根据图片id获取对应评论，但此处只准备了第一张图片的评论，为所有图片公用。
				picid = 1;//var picid = parseInt($(this).attr('id'));
				xmlhttp_comment = new XMLHttpRequest();
				xmlhttp_comment.onreadystatechange = function(){
					if (xmlhttp_comment.readyState == 4 && xmlhttp_comment.status == 200){
						var ocomment = eval(xmlhttp_comment.responseText);
						$('#pages').append(ocomment.nowpage.toString() + '/' + ocomment.allpages.toString());
						if (ocomment.nowpage == 1){
							$('#zuo').css('visibility', 'hidden');
						}else{
							$('#zuo').css('visibility', 'visible');
						}
						if (ocomment.nowpage == ocomment.allpages){
							$('#you').css('visibility', 'hidden');
						}else{
							$('#you').css('visibility', 'visible');
						}
						for (var j = 0; j < ocomment.list.length; j++){
							var li = document.createElement("li");
							$(li).append(ocomment.list[j]);
							$('#commentsul').append(li);
						}
						

					}
				};
				var filename = 'comments/' + picid + '.' + page + '.json';
				xmlhttp_comment.open("GET", filename, true);
				xmlhttp_comment.send();
			}
			function addonepic(picname){//这个函数的作用是将图片picname插入到最短的一列
				var minid = '#col1';//找到最短的一列
				if ($('#col2').height() < $(minid).height()){
					minid = '#col2';
				}
				if ($('#col3').height() < $(minid).height()){
					minid = '#col3';
				}
				if ($('#col4').height() < $(minid).height()){
					minid = '#col4';
				}
				var image = document.createElement("img");
				$(image).attr('id', (parseInt(picname)).toString());
				$(image).attr('src', picname).attr('class', "waterfall-picitem").click(clickpic);
				var div = document.createElement("div");
				$(div).attr('class', 'waterfall-item').append(image);
				//var html1 = '<div class = "waterfall-item"><img src = "';
				//var html2 = '" class = "waterfall-picitem"></div>';
				//var html = html1 + picname + html2;
				$(minid).append(div);
			}
			addPrimaryPics = function(){
				$('.waterfall-picitem').click(function(){alert();});
				setInterval(function(){
					$('.shelter').css('height', $('body').css('height'));
				}, 500);
				$('#zuo').click(function(){//向前翻页
					if (page > 1){
						page--;
					}
					var filename = 'comments/' + picid + '.' + page + '.json';
					xmlhttp_comment.open("GET", filename, true);
					xmlhttp_comment.send();
				});
				$('#you').click(function(){
					page++;
					var filename = 'comments/' + picid + '.' + page + '.json';
					xmlhttp_comment.open("GET", filename, true);
					xmlhttp_comment.send();
				})
				for (var i = 1; i <= 25; i++){
					var picname = i + '.jpg';
					addonepic(picname);
				}
			};
			window.onload = addPrimaryPics;//加载一开始的25张图片
			$(document).scroll(function(event){//检查是不是快到页面底部了
				if(flag == 0){return;}
				flag = 0;//在此次要加载的图片加载完成之前不再响应scroll事件。
				if (($(document).height() - document.body.scrollTop) < 1600){
					xmlhttp = new XMLHttpRequest();
					xmlhttp.onreadystatechange = function(){
						if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
							var picarray = eval(xmlhttp.responseText);
							for(var i = 0; i < picarray.length; i++){
								addonepic(picarray[i]);
							}
							flag = 1;
						}
					}
					var s = index.toString() + '.json';
					xmlhttp.open("GET", s, true);
					xmlhttp.send();
					index++;
					if(index == 4){flag = 0;}
				}
				else{
					flag = 1;
				}
			});
		</script>
		<title>Love Love Love</title>
	</head>
	<body>
		<audio controls autoplay loop preload class = "audio">
			<source src = "bg.mp3" type = "audio/mpeg">
		</audio>
		<div class = "shelter">
			
		</div>
		<div id = "bigpic">
			<div id = "bigpic_pic_div">
				<img id = "bigpic_pic_img">
			</div>
			<div id = "bigpic_comment">
				<div id = "commenttext">
					<ul id = "commentsul">

					</ul>
				</div>
				<div id = "turnpage">
					<img src = "zuo.png" id = "zuo">
					<div id = "pages"></div>
					<img src = "you.png" id = "you">
				</div>
			</div>
		</div>
		<div id = "whole-waterfall">
			<div class = "waterfall-col" id = "col1">
				
			</div>
			<div class = "waterfall-col" id = "col2">
				
			</div>
			<div class = "waterfall-col" id = "col3">
				
			</div>
			<div class = "waterfall-col" id = "col4">
				
			</div>
		</div>
		<script>

		</script>
	</body>
</html>
